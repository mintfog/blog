<!DOCTYPE html><html><head><meta charset="utf-8"><title>php原生socket实现websocket</title><meta name="keywords" content="php,php原生socket,socket,通讯,服务端与客户端通讯,linux,socket原理,数据互通,系列文章,websocket"><meta name="description" content="本文介绍socket的原理与使用php原生方式的简单实现，php原生socket从入门到实战websocket聊天室，webSocket 协议是一种网络通信协议，全双工网络通信协议，html5支持，所有浏览器都兼容了此协议"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/style/main.css"><link rel="stylesheet" href="/style/fontawesome.css"><link rel="stylesheet" href="/style/jquery.fancybox.min.css"><link rel="stylesheet" href="/style/gitalk.css"><script async src="https://www.googletagmanager.com/gtag/js?id=G-2GM6102E19"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-2GM6102E19")</script><style>.github-emoji{position:relative;display:inline-block;width:1.2em;min-height:1.2em;overflow:hidden;vertical-align:top;color:transparent}.github-emoji>span{position:relative;z-index:10}.github-emoji .fancybox,.github-emoji img{margin:0!important;padding:0!important;border:none!important;outline:0!important;text-decoration:none!important;user-select:none!important;cursor:auto!important}.github-emoji img{height:1.2em!important;width:1.2em!important;position:absolute!important;left:50%!important;top:50%!important;transform:translate(-50%,-50%)!important;user-select:none!important;cursor:auto!important}.github-emoji-fallback{color:inherit}.github-emoji-fallback img{opacity:0!important}</style><link rel="alternate" href="/atom.xml" title="codeover" type="application/atom+xml"><link rel="alternate" href="/rss2.xml" title="codeover" type="application/rss+xml"></head><body><div id="app" class="main"><div class="site-header-container"><div class="site-header"><div class="left"> <a href="https://www.codeover.cn"><img class="avatar" src="/images/avatar.png" alt="" width="32px" height="32px"></a><a href="https://www.codeover.cn"><h1 class="site-title">codeover</h1></a></div><div class="right"><i class="icon menu-switch icon-menu-outline"></i></div></div></div><div class="menu-container" style="height:0;opacity:0"><nav class="menu-list"> <a href="/" class="menu purple-link">首页</a> <a href="/tags/" class="menu purple-link">标签</a> <a href="/categories/" class="menu purple-link">分类</a> <a href="/archives/" class="menu purple-link">归档</a> <a href="/about/" class="menu purple-link">关于</a></nav></div><div class="content-container"><div class="post-detail"><h2 class="post-title">php原生socket实现websocket</h2><div class="post-info post-detail-info"><span><i class="icon-calendar-outline"></i> 2022-06-20</span><span><i class="icon-pricetags-outline"></i> <a href="/tags/php/">php ，</a> <a href="/tags/socket/">socket</a></span></div><div class="post-content-wrapper"><div class="post-content"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这是一篇系列文章，文章列表：</p><ol><li><a href="https://www.codeover.cn/php-socket/">php原生socket实现客户端与服务端数据传输</a></li><li><a href="https://www.codeover.cn/php-socket-http/">php原生socket之IO多路复用以及实现web服务器</a></li><li>php原生socket实现websocket</li></ol><h3 id="websocket介绍"><a href="#websocket介绍" class="headerlink" title="websocket介绍"></a>websocket介绍</h3><p>webSocket 协议是一种网络通信协议，在 2008 年诞生，2011 年成为国际标准，<a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc6455">RFC6455</a> 定义了它的通信标准，如今所有浏览器都已支持了该协议。webSocket 是 HTML5 开始提供的一种在单个 TCP 连接上进行全双工<sup id="fnref:1"><a href="#fn:1" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="是通讯传输的一个术语。 通信允许数据在两个方向上同时传输，它在能力上相当于两个单工通信方式的结合
">[1]</span></a></sup>通讯的协议，服务器可以主动向客户端推送消息，客户端也可以主动向服务端发送消息。<br>webSocket 约定了一个通信协议的规范，通过握手机制，客户端（浏览器）和服务器（webserver）之间能建立一个类似 tcp 的连接，从而方便 cs 通信。</p><h3 id="为什么需要websocket"><a href="#为什么需要websocket" class="headerlink" title="为什么需要websocket"></a>为什么需要websocket</h3><p>HTTP 协议是一种无状态的、无连接的、单向的应用层协议。它采用了 <code>请求 =&gt; 响应</code> 模型，通信请求仅能由客户端发起，服务端对请求做出应答处理，这种通信模型有一个弊端：无法实现服务端主动向客户端发起消息。传统的 HTTP 请求，其并发能力都是依赖同时发起多个 TCP 连接访问服务器实现的而 websocket 则允许我们在一条 ws 连接上同时并发多个请求，即在 A 请求发出后 A 响应还未到达，就可以继续发出 B 请求。由于 TCP 的慢启动特性，以及连接本身的握手损耗，都使得 websocket 协议的这一特性有很大的效率提升。</p> <img src="https://cdn.codeover.cn/img/image-20220618222456220.png-imageFop" alt="http与websocket对比" style="zoom:67%"><h3 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h3><ol><li>建立在 TCP 协议之上，服务端的实现相对比较容易</li><li>与 HTTP 协议有良好的兼容性，默认端口也是 80 和 443，并且握手阶段采用 HTTP 协议，因此握手时不容易被屏蔽，能通过各种 HTTP 代理服务器。</li><li>数据格式比较轻量，性能开销小，通信高效。</li><li>可以发送文本，也可以发送二进制数据。</li><li>没有同源限制，客户端可以与任意服务器进行通信。</li><li>协议标识符是 ws（如果加密则为 wss），服务地址就是 URL。</li></ol><h2 id="PHP实现websocket"><a href="#PHP实现websocket" class="headerlink" title="PHP实现websocket"></a>PHP实现websocket</h2><h3 id="客户端与服务端握手"><a href="#客户端与服务端握手" class="headerlink" title="客户端与服务端握手"></a>客户端与服务端握手</h3><p>websocket 协议在连接前需要握手<sup id="fnref:2"><a href="#fn:2" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label=" 为了建立 websocket 连接，需要通过浏览器发出请求，之后服务器进行回应，这个过程通常称为“握手”（Handshaking）">[2]</span></a></sup>，通常握手方式有以下几种方式</p><ul><li><p>基于 flash 的握手协议（不建议）</p></li><li><p>基于 md5 加密方式的握手协议</p><p>较早的握手方法，有两个 key，使用 md5 加密</p></li><li><p>基于 sha1 加密方式的握手协议</p><p>当前主要的握手协议，本文将以此协议为主</p><ol><li>获取客户端上报的 <code>Sec-WebSocket-key</code></li><li>拼接 <code>key</code> + <code>258EAFA5-E914-47DA-95CA-C5AB0DC85B11</code></li><li>对字符串做 <code>SHA1</code> 计算，再把得到的结果通过 <code>base64</code> 加密，最后再返回给客户端</li></ol></li></ul><p>客户端请求信息如下：</p><figure class="highlight http"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/chat</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>server.example.com</span><br><span class="line"><span class="attribute">Upgrade</span><span class="punctuation">: </span>websocket</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>Upgrade</span><br><span class="line"><span class="attribute">Sec-WebSocket-Key</span><span class="punctuation">: </span>dGhlIHNhbXBsZSBub25jZQ==</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://example.com</span><br><span class="line"><span class="attribute">Sec-WebSocket-Protocol</span><span class="punctuation">: </span>chat, superchat</span><br><span class="line"><span class="attribute">Sec-WebSocket-Version</span><span class="punctuation">: </span>13</span><br></pre></td></tr></tbody></table></figure><p>客户端需返回如下数据：</p><figure class="highlight http"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">101</span> Switching Protocols</span><br><span class="line"><span class="attribute">Upgrade</span><span class="punctuation">: </span>websocket</span><br><span class="line"><span class="attribute">Sec-WebSocket-Version</span><span class="punctuation">: </span>13</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>Upgrade</span><br><span class="line"><span class="attribute">Sec-WebSocket-Accept</span><span class="punctuation">: </span>s3pPLMBiTxaQ9kYGzzhZRbK+xOo=</span><br></pre></td></tr></tbody></table></figure><p>我们根据此协议通过 PHP 方式实现：</p><figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$socket</span> = <span class="title function_ invoke__">socket_create</span>(AF_INET, SOCK_STREAM, SOL_TCP);</span><br><span class="line"><span class="title function_ invoke__">socket_set_option</span>(<span class="variable">$socket</span>, SOL_SOCKET, SO_REUSEADDR, <span class="literal">true</span>);</span><br><span class="line"><span class="title function_ invoke__">socket_bind</span>(<span class="variable">$socket</span>, <span class="number">0</span>, <span class="number">8888</span>);</span><br><span class="line"><span class="title function_ invoke__">socket_listen</span>(<span class="variable">$socket</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">    <span class="variable">$conn_sock</span> = <span class="title function_ invoke__">socket_accept</span>(<span class="variable">$socket</span>);</span><br><span class="line">    <span class="variable">$request</span> = <span class="title function_ invoke__">socket_read</span>(<span class="variable">$conn_sock</span>, <span class="number">102400</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$new_key</span> = <span class="title function_ invoke__">getShaKey</span>(<span class="variable">$request</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$response</span> = <span class="string">"HTTP/1.1 101 Switching Protocols\r\n"</span>;</span><br><span class="line">    <span class="variable">$response</span> .= <span class="string">"Upgrade: websocket\r\n"</span>;</span><br><span class="line">    <span class="variable">$response</span> .= <span class="string">"Sec-WebSocket-Version: 13\r\n"</span>;</span><br><span class="line">    <span class="variable">$response</span> .= <span class="string">"Connection: Upgrade\r\n"</span>;</span><br><span class="line">    <span class="variable">$response</span> .= <span class="string">"Sec-WebSocket-Accept: <span class="subst">{$new_key}</span>\r\n\r\n"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">socket_write</span>(<span class="variable">$conn_sock</span>, <span class="variable">$response</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getShaKey</span>(<span class="params"><span class="variable">$request</span></span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="comment">// 获取 Sec-WebSocket-key</span></span><br><span class="line">    <span class="title function_ invoke__">preg_match</span>(<span class="string">"/Sec-WebSocket-Key: (.*)\r\n/"</span>, <span class="variable">$request</span>, <span class="variable">$match</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拼接 key + 258EAFA5-E914-47DA-95CA-C5AB0DC85B11</span></span><br><span class="line">    <span class="variable">$new_key</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$match</span>[<span class="number">1</span>]) . <span class="string">'258EAFA5-E914-47DA-95CA-C5AB0DC85B11'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对字符串做 `SHA1` 计算，再把得到的结果通过 `base64` 加密</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">sha1</span>(<span class="variable">$new_key</span>, <span class="literal">true</span>));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>相关语法解释可参考 <a href="https://www.codeover.cn/php-socket/#%E8%AF%AD%E6%B3%95%E8%A7%A3%E9%87%8A">之前的文章</a>，本文章不做详细介绍。</p><p>使用前端测试，打开我们的任意浏览器控制台（console）输入以下内容，返回的 websocket 对象的 readyState 为 1 即为握手成功，此为前端内容，本文不多做介绍，详情可参考 <a target="_blank" rel="noopener" href="https://www.runoob.com/html/html5-websocket.html">菜鸟教程</a>：</p><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">new</span> <span class="title class_">WebSocket</span>(<span class="string">'ws://192.162.2.166:8888'</span>));</span><br><span class="line"><span class="comment">// 运行后返回：</span></span><br><span class="line"><span class="title class_">WebSocket</span> {</span><br><span class="line">    <span class="attr">binaryType</span>: <span class="string">"blob"</span></span><br><span class="line">    <span class="attr">bufferedAmount</span>: <span class="number">0</span></span><br><span class="line">    <span class="attr">extensions</span>: <span class="string">""</span></span><br><span class="line">    <span class="attr">onclose</span>: <span class="literal">null</span></span><br><span class="line">    <span class="attr">onerror</span>: <span class="literal">null</span></span><br><span class="line">    <span class="attr">onmessage</span>: <span class="literal">null</span></span><br><span class="line">    <span class="attr">onopen</span>: <span class="literal">null</span></span><br><span class="line">    <span class="attr">protocol</span>: <span class="string">""</span></span><br><span class="line">    <span class="attr">readyState</span>: <span class="number">1</span></span><br><span class="line">    <span class="attr">url</span>: <span class="string">"ws://192.162.2.166:8888/"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="发送数据与接收数据"><a href="#发送数据与接收数据" class="headerlink" title="发送数据与接收数据"></a>发送数据与接收数据</h3><p>使用 websocket 协议传输协议需要遵循特定的格式规范，详情请参考 <a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc6455#section-5.2">https://datatracker.ietf.org/doc/html/rfc6455#section-5.2</a></p><p><img src="https://cdn.codeover.cn/img/image-20220619231347489.png-imageFop" alt="发送数据与接收数据"></p><p>为了方便，这里直接贴出加解密代码，以下代码借鉴与 <a target="_blank" rel="noopener" href="https://github.com/walkor/workerman/">workerman</a> 的 <code>src/Protocols/Websocket.php</code> 文件：</p><figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 解码客户端发送的消息</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">decode</span>(<span class="params"><span class="variable">$buffer</span></span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="variable">$len</span> = \<span class="title function_ invoke__">ord</span>(<span class="variable">$buffer</span>[<span class="number">1</span>]) &amp; <span class="number">127</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$len</span> === <span class="number">126</span>) {</span><br><span class="line">        <span class="variable">$masks</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">4</span>, <span class="number">4</span>);</span><br><span class="line">        <span class="variable">$data</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">8</span>);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$len</span> === <span class="number">127</span>) {</span><br><span class="line">            <span class="variable">$masks</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">10</span>, <span class="number">4</span>);</span><br><span class="line">            <span class="variable">$data</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">14</span>);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="variable">$masks</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">2</span>, <span class="number">4</span>);</span><br><span class="line">            <span class="variable">$data</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">6</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="variable">$dataLength</span> = \<span class="title function_ invoke__">strlen</span>(<span class="variable">$data</span>);</span><br><span class="line">    <span class="variable">$masks</span> = \<span class="title function_ invoke__">str_repeat</span>(<span class="variable">$masks</span>, \<span class="title function_ invoke__">floor</span>(<span class="variable">$dataLength</span> / <span class="number">4</span>)) . \<span class="title function_ invoke__">substr</span>(<span class="variable">$masks</span>, <span class="number">0</span>, <span class="variable">$dataLength</span> % <span class="number">4</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$data</span> ^ <span class="variable">$masks</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 编码发送给客户端的消息</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">encode</span>(<span class="params"><span class="variable">$buffer</span></span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">is_scalar</span>(<span class="variable">$buffer</span>)) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">\Exception</span>(<span class="string">"You can't send("</span> . \<span class="title function_ invoke__">gettype</span>(<span class="variable">$buffer</span>) . <span class="string">") to client, you need to convert it to a string. "</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="variable">$len</span> = \<span class="title function_ invoke__">strlen</span>(<span class="variable">$buffer</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$first_byte</span> = <span class="string">"\x81"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$len</span> &lt;= <span class="number">125</span>) {</span><br><span class="line">        <span class="variable">$encode_buffer</span> = <span class="variable">$first_byte</span> . \<span class="title function_ invoke__">chr</span>(<span class="variable">$len</span>) . <span class="variable">$buffer</span>;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$len</span> &lt;= <span class="number">65535</span>) {</span><br><span class="line">            <span class="variable">$encode_buffer</span> = <span class="variable">$first_byte</span> . \<span class="title function_ invoke__">chr</span>(<span class="number">126</span>) . \<span class="title function_ invoke__">pack</span>(<span class="string">"n"</span>, <span class="variable">$len</span>) . <span class="variable">$buffer</span>;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="variable">$encode_buffer</span> = <span class="variable">$first_byte</span> . \<span class="title function_ invoke__">chr</span>(<span class="number">127</span>) . \<span class="title function_ invoke__">pack</span>(<span class="string">"xxxxN"</span>, <span class="variable">$len</span>) . <span class="variable">$buffer</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$encode_buffer</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>我们修改刚才 <a href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%B8%8E%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%8F%A1%E6%89%8B">客户端与服务端握手</a> 阶段的代码，修改后全代码全文如下，该段代码实现了将客户端发送的消息转为大写后返回给客户端（当然只是为了演示）：</p><figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$socket</span> = <span class="title function_ invoke__">socket_create</span>(AF_INET, SOCK_STREAM, SOL_TCP);</span><br><span class="line"><span class="title function_ invoke__">socket_set_option</span>(<span class="variable">$socket</span>, SOL_SOCKET, SO_REUSEADDR, <span class="literal">true</span>);</span><br><span class="line"><span class="title function_ invoke__">socket_bind</span>(<span class="variable">$socket</span>, <span class="number">0</span>, <span class="number">8888</span>);</span><br><span class="line"><span class="title function_ invoke__">socket_listen</span>(<span class="variable">$socket</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">    <span class="variable">$conn_sock</span> = <span class="title function_ invoke__">socket_accept</span>(<span class="variable">$socket</span>);</span><br><span class="line">    <span class="variable">$request</span> = <span class="title function_ invoke__">socket_read</span>(<span class="variable">$conn_sock</span>, <span class="number">102400</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$new_key</span> = <span class="title function_ invoke__">getShaKey</span>(<span class="variable">$request</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$response</span> = <span class="string">"HTTP/1.1 101 Switching Protocols\r\n"</span>;</span><br><span class="line">    <span class="variable">$response</span> .= <span class="string">"Upgrade: websocket\r\n"</span>;</span><br><span class="line">    <span class="variable">$response</span> .= <span class="string">"Sec-WebSocket-Version: 13\r\n"</span>;</span><br><span class="line">    <span class="variable">$response</span> .= <span class="string">"Connection: Upgrade\r\n"</span>;</span><br><span class="line">    <span class="variable">$response</span> .= <span class="string">"Sec-WebSocket-Accept: <span class="subst">{$new_key}</span>\r\n\r\n"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送握手数据</span></span><br><span class="line">    <span class="title function_ invoke__">socket_write</span>(<span class="variable">$conn_sock</span>, <span class="variable">$response</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 新增内容，获取客户端发送的消息并转为大写还给客户端</span></span><br><span class="line">    <span class="variable">$msg</span> = <span class="title function_ invoke__">socket_read</span>(<span class="variable">$conn_sock</span>, <span class="number">102400</span>);</span><br><span class="line">    <span class="title function_ invoke__">socket_write</span>(<span class="variable">$conn_sock</span>, <span class="title function_ invoke__">encode</span>(<span class="title function_ invoke__">strtoupper</span>(<span class="title function_ invoke__">decode</span>(<span class="variable">$msg</span>))));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getShaKey</span>(<span class="params"><span class="variable">$request</span></span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="comment">// 获取 Sec-WebSocket-key</span></span><br><span class="line">    <span class="title function_ invoke__">preg_match</span>(<span class="string">"/Sec-WebSocket-Key: (.*)\r\n/"</span>, <span class="variable">$request</span>, <span class="variable">$match</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拼接 key + 258EAFA5-E914-47DA-95CA-C5AB0DC85B11</span></span><br><span class="line">    <span class="variable">$new_key</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$match</span>[<span class="number">1</span>]) . <span class="string">'258EAFA5-E914-47DA-95CA-C5AB0DC85B11'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对字符串做 `SHA1` 计算，再把得到的结果通过 `base64` 加密</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">sha1</span>(<span class="variable">$new_key</span>, <span class="literal">true</span>));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">decode</span>(<span class="params"><span class="variable">$buffer</span></span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="variable">$len</span> = \<span class="title function_ invoke__">ord</span>(<span class="variable">$buffer</span>[<span class="number">1</span>]) &amp; <span class="number">127</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$len</span> === <span class="number">126</span>) {</span><br><span class="line">        <span class="variable">$masks</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">4</span>, <span class="number">4</span>);</span><br><span class="line">        <span class="variable">$data</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">8</span>);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$len</span> === <span class="number">127</span>) {</span><br><span class="line">            <span class="variable">$masks</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">10</span>, <span class="number">4</span>);</span><br><span class="line">            <span class="variable">$data</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">14</span>);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="variable">$masks</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">2</span>, <span class="number">4</span>);</span><br><span class="line">            <span class="variable">$data</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">6</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="variable">$dataLength</span> = \<span class="title function_ invoke__">strlen</span>(<span class="variable">$data</span>);</span><br><span class="line">    <span class="variable">$masks</span> = \<span class="title function_ invoke__">str_repeat</span>(<span class="variable">$masks</span>, \<span class="title function_ invoke__">floor</span>(<span class="variable">$dataLength</span> / <span class="number">4</span>)) . \<span class="title function_ invoke__">substr</span>(<span class="variable">$masks</span>, <span class="number">0</span>, <span class="variable">$dataLength</span> % <span class="number">4</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$data</span> ^ <span class="variable">$masks</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">encode</span>(<span class="params"><span class="variable">$buffer</span></span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">is_scalar</span>(<span class="variable">$buffer</span>)) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">\Exception</span>(<span class="string">"You can't send("</span> . \<span class="title function_ invoke__">gettype</span>(<span class="variable">$buffer</span>) . <span class="string">") to client, you need to convert it to a string. "</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="variable">$len</span> = \<span class="title function_ invoke__">strlen</span>(<span class="variable">$buffer</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$first_byte</span> = <span class="string">"\x81"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$len</span> &lt;= <span class="number">125</span>) {</span><br><span class="line">        <span class="variable">$encode_buffer</span> = <span class="variable">$first_byte</span> . \<span class="title function_ invoke__">chr</span>(<span class="variable">$len</span>) . <span class="variable">$buffer</span>;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$len</span> &lt;= <span class="number">65535</span>) {</span><br><span class="line">            <span class="variable">$encode_buffer</span> = <span class="variable">$first_byte</span> . \<span class="title function_ invoke__">chr</span>(<span class="number">126</span>) . \<span class="title function_ invoke__">pack</span>(<span class="string">"n"</span>, <span class="variable">$len</span>) . <span class="variable">$buffer</span>;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="variable">$encode_buffer</span> = <span class="variable">$first_byte</span> . \<span class="title function_ invoke__">chr</span>(<span class="number">127</span>) . \<span class="title function_ invoke__">pack</span>(<span class="string">"xxxxN"</span>, <span class="variable">$len</span>) . <span class="variable">$buffer</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$encode_buffer</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>使用 <a target="_blank" rel="noopener" href="http://www.websocket-test.com/">在线测试工具</a> 进行测试，可以看到消息已经可以正常发送接收，接下来的文章将继续优化代码，实现简易聊天室，敬请关注：</p><p><img src="https://cdn.codeover.cn/img/GIF2022-6-2023-53-02.gif-imageFop" alt="测试截图"></p><div id="footnotes"><hr><div id="footnotelist"><ol style="list-style:none;padding-left:0;margin-left:40px"><li id="fn:1"><span style="display:inline-block;vertical-align:top;padding-right:10px;margin-left:-40px">1.</span><span style="display:inline-block;vertical-align:top;margin-left:10px">是通讯传输的一个术语。 通信允许数据在两个方向上同时传输，它在能力上相当于两个单工通信方式的结合 <a href="#fnref:1" rev="footnote">↩</a></span></li><li id="fn:2"><span style="display:inline-block;vertical-align:top;padding-right:10px;margin-left:-40px">2.</span><span style="display:inline-block;vertical-align:top;margin-left:10px">为了建立 websocket 连接，需要通过浏览器发出请求，之后服务器进行回应，这个过程通常称为“握手”（Handshaking） <a href="#fnref:2" rev="footnote">↩</a></span></li></ol></div></div></div><div class="top-div"><ol class="top-box"><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#%E5%89%8D%E8%A8%80"><span class="top-box-text">前言</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#websocket%E4%BB%8B%E7%BB%8D"><span class="top-box-text">websocket介绍</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81websocket"><span class="top-box-text">为什么需要websocket</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E7%89%B9%E7%82%B9"><span class="top-box-text">特点</span></a></li></ol></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#PHP%E5%AE%9E%E7%8E%B0websocket"><span class="top-box-text">PHP实现websocket</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%B8%8E%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%8F%A1%E6%89%8B"><span class="top-box-text">客户端与服务端握手</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E4%B8%8E%E6%8E%A5%E6%94%B6%E6%95%B0%E6%8D%AE"><span class="top-box-text">发送数据与接收数据</span></a></li></ol></li></ol></div></div></div><div class="next-post"><a class="purple-link" href="/php-socket-http/"><h3 class="post-title"> 下一篇：php原生socket之IO多路复用以及实现web服务器</h3></a></div></div><div id="gitalk-container"></div><footer><div class="site-footer"><div class="social-container"><a href="https://github.com/f-dong" target="_blank"><i class="fab fa-github"></i></a></div> Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <a href="https://github.com/f-dong/hexo-theme-minimalism" target="_blank">Theme</a> | <a class="icp" href="https://beian.miit.gov.cn" target="_blank">豫ICP备2022011962号</a> | <a class="icp" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=41010402002848" target="_blank">豫公网安备41010402002848号</a></div></footer></div><script src="/js/jquery.min.js"></script><script src="/js/jquery.fancybox.min.js"></script><script src="/js/main.js"></script><script src="/js/gitalk.min.js"></script><script>var gitalk=new Gitalk({clientID:"eaa8ec37487184406145",clientSecret:"77f9955d0267c1331df7cc706cfa385d2befb9c6",repo:"blog",owner:"f-dong",admin:["f-dong"],id:location.pathname.slice(1,location.pathname.lastIndexOf("/")).substring(0,49),distractionFreeMode:!1,createIssueManually:!0});gitalk.render("gitalk-container")</script></body></html>