<!DOCTYPE html><html lang="zh-CN"><head><script>!function(){var e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,t=localStorage.getItem("use-color-scheme")||"auto";("dark"===t||e&&"light"!==t)&&document.documentElement.classList.toggle("dark",!0)}()</script><meta charset="utf-8"><title>phpåŸç”Ÿsocketå®ç°websocketèŠå¤©å®¤</title><meta name="keywords" content="php,phpåŸç”Ÿsocket,socket,é€šè®¯,æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯é€šè®¯,linux,socketåŸç†,æ•°æ®äº’é€š,ç³»åˆ—æ–‡ç« ,websocket"><meta name="description" content="æœ¬æ–‡ä»‹ç»socketçš„åŸç†ä¸ä½¿ç”¨phpåŸç”Ÿæ–¹å¼çš„ç®€å•å®ç°ï¼ŒphpåŸç”Ÿsocketä»å…¥é—¨åˆ°å®æˆ˜websocketèŠå¤©å®¤ï¼ŒwebSocket åè®®æ˜¯ä¸€ç§ç½‘ç»œé€šä¿¡åè®®ï¼Œå…¨åŒå·¥ç½‘ç»œé€šä¿¡åè®®ï¼Œhtml5æ”¯æŒï¼Œæ‰€æœ‰æµè§ˆå™¨éƒ½å…¼å®¹äº†æ­¤åè®®"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/style/main.css"><link rel="stylesheet" href="/style/gitalk.min.css"><link rel="stylesheet" href="/style/simple-lightbox.min.css"><link rel="alternate" href="/atom.xml" title="codeover" type="application/atom+xml"><link rel="alternate" href="/rss2.xml" title="codeover" type="application/rss+xml"></head><body><div id="app" class="main"><div class="site-header-container"><div class="site-header"><div class="left"> <a href="https://www.codeover.cn"><img class="avatar" src="/images/avatar.png" alt="logo" width="32px" height="32px"></a><a href="https://www.codeover.cn"><h1 class="site-title">codeover</h1></a></div><div class="right"><i class="icon menu-switch icon-menu-outline"></i></div></div></div><div class="menu-container" style="height:0;opacity:0"><nav class="menu-list"> <a href="/" class="menu purple-link">é¦–é¡µ</a> <a href="/tags/" class="menu purple-link">æ ‡ç­¾</a> <a href="/categories/" class="menu purple-link">åˆ†ç±»</a> <a href="/archives/" class="menu purple-link">å½’æ¡£</a> <a href="/about/" class="menu purple-link">å…³äº</a></nav></div><div class="content-container"><div class="post-detail"><h2 class="post-title">phpåŸç”Ÿsocketå®ç°websocketèŠå¤©å®¤</h2><div class="post-info post-detail-info"><span><i class="icon icon-calendar-outline"></i> 2022-06-20</span><span><i class="icon icon-pricetags-outline"></i> <a href="/tags/php/">php ï¼Œ</a> <a href="/tags/socket/">socket</a></span></div><div class="post-content-wrapper"><div class="post-content"><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>è¿™æ˜¯ä¸€ç¯‡ç³»åˆ—æ–‡ç« ï¼Œæ–‡ç« åˆ—è¡¨ï¼š</p><ol><li><a href="https://www.codeover.cn/php-socket/">phpåŸç”Ÿsocketå®ç°å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯æ•°æ®ä¼ è¾“</a></li><li><a href="https://www.codeover.cn/php-socket-http/">phpåŸç”Ÿsocketä¹‹IOå¤šè·¯å¤ç”¨ä»¥åŠå®ç°webæœåŠ¡å™¨</a></li><li>phpåŸç”Ÿsocketå®ç°websocketèŠå¤©å®¤</li></ol><h3 id="websocketä»‹ç»"><a href="#websocketä»‹ç»" class="headerlink" title="websocketä»‹ç»"></a>websocketä»‹ç»</h3><p>webSocket åè®®æ˜¯ä¸€ç§ç½‘ç»œé€šä¿¡åè®®ï¼Œåœ¨ 2008 å¹´è¯ç”Ÿï¼Œ2011 å¹´æˆä¸ºå›½é™…æ ‡å‡†ï¼Œ<a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc6455">RFC6455</a> å®šä¹‰äº†å®ƒçš„é€šä¿¡æ ‡å‡†ï¼Œå¦‚ä»Šæ‰€æœ‰æµè§ˆå™¨éƒ½å·²æ”¯æŒäº†è¯¥åè®®ã€‚webSocket æ˜¯ HTML5 å¼€å§‹æä¾›çš„ä¸€ç§åœ¨å•ä¸ª TCP è¿æ¥ä¸Šè¿›è¡Œå…¨åŒå·¥<sup id="fnref:1"><a href="#fn:1" rel="footnote"><span class="footnote--top">[1]<content class="footnote--pop-ups">æ˜¯é€šè®¯ä¼ è¾“çš„ä¸€ä¸ªæœ¯è¯­ã€‚ é€šä¿¡å…è®¸æ•°æ®åœ¨ä¸¤ä¸ªæ–¹å‘ä¸ŠåŒæ—¶ä¼ è¾“ï¼Œå®ƒåœ¨èƒ½åŠ›ä¸Šç›¸å½“äºä¸¤ä¸ªå•å·¥é€šä¿¡æ–¹å¼çš„ç»“åˆ</content></span></a></sup>é€šè®¯çš„åè®®ï¼ŒæœåŠ¡å™¨å¯ä»¥ä¸»åŠ¨å‘å®¢æˆ·ç«¯æ¨é€æ¶ˆæ¯ï¼Œå®¢æˆ·ç«¯ä¹Ÿå¯ä»¥ä¸»åŠ¨å‘æœåŠ¡ç«¯å‘é€æ¶ˆæ¯ã€‚<br>webSocket çº¦å®šäº†ä¸€ä¸ªé€šä¿¡åè®®çš„è§„èŒƒï¼Œé€šè¿‡æ¡æ‰‹æœºåˆ¶ï¼Œå®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨ï¼‰å’ŒæœåŠ¡å™¨ï¼ˆwebserverï¼‰ä¹‹é—´èƒ½å»ºç«‹ä¸€ä¸ªç±»ä¼¼ tcp çš„è¿æ¥ï¼Œä»è€Œæ–¹ä¾¿ cs é€šä¿¡ã€‚</p><h3 id="ä¸ºä»€ä¹ˆéœ€è¦websocket"><a href="#ä¸ºä»€ä¹ˆéœ€è¦websocket" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦websocket"></a>ä¸ºä»€ä¹ˆéœ€è¦websocket</h3><p>HTTP åè®®æ˜¯ä¸€ç§æ— çŠ¶æ€çš„ã€æ— è¿æ¥çš„ã€å•å‘çš„åº”ç”¨å±‚åè®®ã€‚å®ƒé‡‡ç”¨äº† <code>è¯·æ±‚ =&gt; å“åº”</code> æ¨¡å‹ï¼Œé€šä¿¡è¯·æ±‚ä»…èƒ½ç”±å®¢æˆ·ç«¯å‘èµ·ï¼ŒæœåŠ¡ç«¯å¯¹è¯·æ±‚åšå‡ºåº”ç­”å¤„ç†ï¼Œè¿™ç§é€šä¿¡æ¨¡å‹æœ‰ä¸€ä¸ªå¼Šç«¯ï¼šæ— æ³•å®ç°æœåŠ¡ç«¯ä¸»åŠ¨å‘å®¢æˆ·ç«¯å‘èµ·æ¶ˆæ¯ã€‚ä¼ ç»Ÿçš„ HTTP è¯·æ±‚ï¼Œå…¶å¹¶å‘èƒ½åŠ›éƒ½æ˜¯ä¾èµ–åŒæ—¶å‘èµ·å¤šä¸ª TCP è¿æ¥è®¿é—®æœåŠ¡å™¨å®ç°çš„è€Œ websocket åˆ™å…è®¸æˆ‘ä»¬åœ¨ä¸€æ¡ ws è¿æ¥ä¸ŠåŒæ—¶å¹¶å‘å¤šä¸ªè¯·æ±‚ï¼Œå³åœ¨ A è¯·æ±‚å‘å‡ºå A å“åº”è¿˜æœªåˆ°è¾¾ï¼Œå°±å¯ä»¥ç»§ç»­å‘å‡º B è¯·æ±‚ã€‚ç”±äº TCP çš„æ…¢å¯åŠ¨ç‰¹æ€§ï¼Œä»¥åŠè¿æ¥æœ¬èº«çš„æ¡æ‰‹æŸè€—ï¼Œéƒ½ä½¿å¾— websocket åè®®çš„è¿™ä¸€ç‰¹æ€§æœ‰å¾ˆå¤§çš„æ•ˆç‡æå‡ã€‚</p> <a class="simple-lightbox" target="_blank" rel="noopener" href="https://cdn.codeover.cn/img/image-20220618222456220.png-imageFop"><img src="/images/loading.svg" data-src="https://cdn.codeover.cn/img/image-20220618222456220.png-imageFop" alt="httpä¸websocketå¯¹æ¯”" style="zoom:67%" lazyload=""></a><h3 id="ç‰¹ç‚¹"><a href="#ç‰¹ç‚¹" class="headerlink" title="ç‰¹ç‚¹"></a>ç‰¹ç‚¹</h3><ol><li>å»ºç«‹åœ¨ TCP åè®®ä¹‹ä¸Šï¼ŒæœåŠ¡ç«¯çš„å®ç°ç›¸å¯¹æ¯”è¾ƒå®¹æ˜“</li><li>ä¸ HTTP åè®®æœ‰è‰¯å¥½çš„å…¼å®¹æ€§ï¼Œé»˜è®¤ç«¯å£ä¹Ÿæ˜¯ 80 å’Œ 443ï¼Œå¹¶ä¸”æ¡æ‰‹é˜¶æ®µé‡‡ç”¨ HTTP åè®®ï¼Œå› æ­¤æ¡æ‰‹æ—¶ä¸å®¹æ˜“è¢«å±è”½ï¼Œèƒ½é€šè¿‡å„ç§ HTTP ä»£ç†æœåŠ¡å™¨ã€‚</li><li>æ•°æ®æ ¼å¼æ¯”è¾ƒè½»é‡ï¼Œæ€§èƒ½å¼€é”€å°ï¼Œé€šä¿¡é«˜æ•ˆã€‚</li><li>å¯ä»¥å‘é€æ–‡æœ¬ï¼Œä¹Ÿå¯ä»¥å‘é€äºŒè¿›åˆ¶æ•°æ®ã€‚</li><li>æ²¡æœ‰åŒæºé™åˆ¶ï¼Œå®¢æˆ·ç«¯å¯ä»¥ä¸ä»»æ„æœåŠ¡å™¨è¿›è¡Œé€šä¿¡ã€‚</li><li>åè®®æ ‡è¯†ç¬¦æ˜¯ wsï¼ˆå¦‚æœåŠ å¯†åˆ™ä¸º wssï¼‰ï¼ŒæœåŠ¡åœ°å€å°±æ˜¯ URLã€‚</li></ol><h2 id="PHPå®ç°websocket"><a href="#PHPå®ç°websocket" class="headerlink" title="PHPå®ç°websocket"></a>PHPå®ç°websocket</h2><h3 id="å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯æ¡æ‰‹"><a href="#å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯æ¡æ‰‹" class="headerlink" title="å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯æ¡æ‰‹"></a>å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯æ¡æ‰‹</h3><p>websocket åè®®åœ¨è¿æ¥å‰éœ€è¦æ¡æ‰‹<sup id="fnref:2"><a href="#fn:2" rel="footnote"><span class="footnote--top">[2]<content class="footnote--pop-ups">ä¸ºäº†å»ºç«‹ websocket è¿æ¥ï¼Œéœ€è¦é€šè¿‡æµè§ˆå™¨å‘å‡ºè¯·æ±‚ï¼Œä¹‹åæœåŠ¡å™¨è¿›è¡Œå›åº”ï¼Œè¿™ä¸ªè¿‡ç¨‹é€šå¸¸ç§°ä¸ºâ€œæ¡æ‰‹â€ï¼ˆHandshakingï¼‰</content></span></a></sup>ï¼Œé€šå¸¸æ¡æ‰‹æ–¹å¼æœ‰ä»¥ä¸‹å‡ ç§æ–¹å¼</p><ul><li><p>åŸºäº flash çš„æ¡æ‰‹åè®®ï¼ˆä¸å»ºè®®ï¼‰</p></li><li><p>åŸºäº md5 åŠ å¯†æ–¹å¼çš„æ¡æ‰‹åè®®</p><p>è¾ƒæ—©çš„æ¡æ‰‹æ–¹æ³•ï¼Œæœ‰ä¸¤ä¸ª keyï¼Œä½¿ç”¨ md5 åŠ å¯†</p></li><li><p>åŸºäº sha1 åŠ å¯†æ–¹å¼çš„æ¡æ‰‹åè®®</p><p>å½“å‰ä¸»è¦çš„æ¡æ‰‹åè®®ï¼Œæœ¬æ–‡å°†ä»¥æ­¤åè®®ä¸ºä¸»</p><ol><li>è·å–å®¢æˆ·ç«¯ä¸ŠæŠ¥çš„ <code>Sec-WebSocket-key</code></li><li>æ‹¼æ¥ <code>key</code> + <code>258EAFA5-E914-47DA-95CA-C5AB0DC85B11</code></li><li>å¯¹å­—ç¬¦ä¸²åš <code>SHA1</code> è®¡ç®—ï¼Œå†æŠŠå¾—åˆ°çš„ç»“æœé€šè¿‡ <code>base64</code> åŠ å¯†ï¼Œæœ€åå†è¿”å›ç»™å®¢æˆ·ç«¯</li></ol></li></ul><p>å®¢æˆ·ç«¯è¯·æ±‚ä¿¡æ¯å¦‚ä¸‹ï¼š</p><figure class="highlight http"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/chat</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>server.example.com</span><br><span class="line"><span class="attribute">Upgrade</span><span class="punctuation">: </span>websocket</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>Upgrade</span><br><span class="line"><span class="attribute">Sec-WebSocket-Key</span><span class="punctuation">: </span>dGhlIHNhbXBsZSBub25jZQ==</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://example.com</span><br><span class="line"><span class="attribute">Sec-WebSocket-Protocol</span><span class="punctuation">: </span>chat, superchat</span><br><span class="line"><span class="attribute">Sec-WebSocket-Version</span><span class="punctuation">: </span>13</span><br></pre></td></tr></tbody></table></figure><p>å®¢æˆ·ç«¯éœ€è¿”å›å¦‚ä¸‹æ•°æ®ï¼š</p><figure class="highlight http"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">101</span> Switching Protocols</span><br><span class="line"><span class="attribute">Upgrade</span><span class="punctuation">: </span>websocket</span><br><span class="line"><span class="attribute">Sec-WebSocket-Version</span><span class="punctuation">: </span>13</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>Upgrade</span><br><span class="line"><span class="attribute">Sec-WebSocket-Accept</span><span class="punctuation">: </span>s3pPLMBiTxaQ9kYGzzhZRbK+xOo=</span><br></pre></td></tr></tbody></table></figure><p>æˆ‘ä»¬æ ¹æ®æ­¤åè®®é€šè¿‡ PHP æ–¹å¼å®ç°ï¼š</p><figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$socket</span> = <span class="title function_ invoke__">socket_create</span>(AF_INET, SOCK_STREAM, SOL_TCP);</span><br><span class="line"><span class="title function_ invoke__">socket_set_option</span>(<span class="variable">$socket</span>, SOL_SOCKET, SO_REUSEADDR, <span class="literal">true</span>);</span><br><span class="line"><span class="title function_ invoke__">socket_bind</span>(<span class="variable">$socket</span>, <span class="number">0</span>, <span class="number">8888</span>);</span><br><span class="line"><span class="title function_ invoke__">socket_listen</span>(<span class="variable">$socket</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">    <span class="variable">$conn_sock</span> = <span class="title function_ invoke__">socket_accept</span>(<span class="variable">$socket</span>);</span><br><span class="line">    <span class="variable">$request</span> = <span class="title function_ invoke__">socket_read</span>(<span class="variable">$conn_sock</span>, <span class="number">102400</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$new_key</span> = <span class="title function_ invoke__">getShaKey</span>(<span class="variable">$request</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$response</span> = <span class="string">"HTTP/1.1 101 Switching Protocols\r\n"</span>;</span><br><span class="line">    <span class="variable">$response</span> .= <span class="string">"Upgrade: websocket\r\n"</span>;</span><br><span class="line">    <span class="variable">$response</span> .= <span class="string">"Sec-WebSocket-Version: 13\r\n"</span>;</span><br><span class="line">    <span class="variable">$response</span> .= <span class="string">"Connection: Upgrade\r\n"</span>;</span><br><span class="line">    <span class="variable">$response</span> .= <span class="string">"Sec-WebSocket-Accept: <span class="subst">{$new_key}</span>\r\n\r\n"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">socket_write</span>(<span class="variable">$conn_sock</span>, <span class="variable">$response</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getShaKey</span>(<span class="params"><span class="variable">$request</span></span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="comment">// è·å– Sec-WebSocket-key</span></span><br><span class="line">    <span class="title function_ invoke__">preg_match</span>(<span class="string">"/Sec-WebSocket-Key: (.*)\r\n/"</span>, <span class="variable">$request</span>, <span class="variable">$match</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‹¼æ¥ key + 258EAFA5-E914-47DA-95CA-C5AB0DC85B11</span></span><br><span class="line">    <span class="variable">$new_key</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$match</span>[<span class="number">1</span>]) . <span class="string">'258EAFA5-E914-47DA-95CA-C5AB0DC85B11'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯¹å­—ç¬¦ä¸²åš `SHA1` è®¡ç®—ï¼Œå†æŠŠå¾—åˆ°çš„ç»“æœé€šè¿‡ `base64` åŠ å¯†</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">sha1</span>(<span class="variable">$new_key</span>, <span class="literal">true</span>));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>ç›¸å…³è¯­æ³•è§£é‡Šå¯å‚è€ƒ <a href="https://www.codeover.cn/php-socket/#%E8%AF%AD%E6%B3%95%E8%A7%A3%E9%87%8A">ä¹‹å‰çš„æ–‡ç« </a>ï¼Œæœ¬æ–‡ç« ä¸åšè¯¦ç»†ä»‹ç»ã€‚</p><p>ä½¿ç”¨å‰ç«¯æµ‹è¯•ï¼Œæ‰“å¼€æˆ‘ä»¬çš„ä»»æ„æµè§ˆå™¨æ§åˆ¶å°ï¼ˆconsoleï¼‰è¾“å…¥ä»¥ä¸‹å†…å®¹ï¼Œè¿”å›çš„ websocket å¯¹è±¡çš„ readyState ä¸º 1 å³ä¸ºæ¡æ‰‹æˆåŠŸï¼Œæ­¤ä¸ºå‰ç«¯å†…å®¹ï¼Œæœ¬æ–‡ä¸å¤šåšä»‹ç»ï¼Œè¯¦æƒ…å¯å‚è€ƒ <a target="_blank" rel="noopener" href="https://www.runoob.com/html/html5-websocket.html">èœé¸Ÿæ•™ç¨‹</a>ï¼š</p><figure class="highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">new</span> <span class="title class_">WebSocket</span>(<span class="string">'ws://192.162.2.166:8888'</span>));</span><br><span class="line"><span class="comment">// è¿è¡Œåè¿”å›ï¼š</span></span><br><span class="line"><span class="title class_">WebSocket</span> {</span><br><span class="line">    <span class="attr">binaryType</span>: <span class="string">"blob"</span></span><br><span class="line">    <span class="attr">bufferedAmount</span>: <span class="number">0</span></span><br><span class="line">    <span class="attr">extensions</span>: <span class="string">""</span></span><br><span class="line">    <span class="attr">onclose</span>: <span class="literal">null</span></span><br><span class="line">    <span class="attr">onerror</span>: <span class="literal">null</span></span><br><span class="line">    <span class="attr">onmessage</span>: <span class="literal">null</span></span><br><span class="line">    <span class="attr">onopen</span>: <span class="literal">null</span></span><br><span class="line">    <span class="attr">protocol</span>: <span class="string">""</span></span><br><span class="line">    <span class="attr">readyState</span>: <span class="number">1</span></span><br><span class="line">    <span class="attr">url</span>: <span class="string">"ws://192.162.2.166:8888/"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="å‘é€æ•°æ®ä¸æ¥æ”¶æ•°æ®"><a href="#å‘é€æ•°æ®ä¸æ¥æ”¶æ•°æ®" class="headerlink" title="å‘é€æ•°æ®ä¸æ¥æ”¶æ•°æ®"></a>å‘é€æ•°æ®ä¸æ¥æ”¶æ•°æ®</h3><p>ä½¿ç”¨ websocket åè®®ä¼ è¾“åè®®éœ€è¦éµå¾ªç‰¹å®šçš„æ ¼å¼è§„èŒƒï¼Œè¯¦æƒ…è¯·å‚è€ƒ <a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc6455#section-5.2">https://datatracker.ietf.org/doc/html/rfc6455#section-5.2</a></p><p><a class="simple-lightbox" target="_blank" rel="noopener" href="https://cdn.codeover.cn/img/image-20220619231347489.png-imageFop"><img src="/images/loading.svg" data-src="https://cdn.codeover.cn/img/image-20220619231347489.png-imageFop" alt="å‘é€æ•°æ®ä¸æ¥æ”¶æ•°æ®" lazyload=""></a></p><p>ä¸ºäº†æ–¹ä¾¿ï¼Œè¿™é‡Œç›´æ¥è´´å‡ºåŠ è§£å¯†ä»£ç ï¼Œä»¥ä¸‹ä»£ç å€Ÿé‰´ä¸ <a target="_blank" rel="noopener" href="https://github.com/walkor/workerman/">workerman</a> çš„ <code>src/Protocols/Websocket.php</code> æ–‡ä»¶ï¼š</p><figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// è§£ç å®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">decode</span>(<span class="params"><span class="variable">$buffer</span></span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="variable">$len</span> = \<span class="title function_ invoke__">ord</span>(<span class="variable">$buffer</span>[<span class="number">1</span>]) &amp; <span class="number">127</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$len</span> === <span class="number">126</span>) {</span><br><span class="line">        <span class="variable">$masks</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">4</span>, <span class="number">4</span>);</span><br><span class="line">        <span class="variable">$data</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">8</span>);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$len</span> === <span class="number">127</span>) {</span><br><span class="line">            <span class="variable">$masks</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">10</span>, <span class="number">4</span>);</span><br><span class="line">            <span class="variable">$data</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">14</span>);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="variable">$masks</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">2</span>, <span class="number">4</span>);</span><br><span class="line">            <span class="variable">$data</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">6</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="variable">$dataLength</span> = \<span class="title function_ invoke__">strlen</span>(<span class="variable">$data</span>);</span><br><span class="line">    <span class="variable">$masks</span> = \<span class="title function_ invoke__">str_repeat</span>(<span class="variable">$masks</span>, \<span class="title function_ invoke__">floor</span>(<span class="variable">$dataLength</span> / <span class="number">4</span>)) . \<span class="title function_ invoke__">substr</span>(<span class="variable">$masks</span>, <span class="number">0</span>, <span class="variable">$dataLength</span> % <span class="number">4</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$data</span> ^ <span class="variable">$masks</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¼–ç å‘é€ç»™å®¢æˆ·ç«¯çš„æ¶ˆæ¯</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">encode</span>(<span class="params"><span class="variable">$buffer</span></span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">is_scalar</span>(<span class="variable">$buffer</span>)) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">\Exception</span>(<span class="string">"You can't send("</span> . \<span class="title function_ invoke__">gettype</span>(<span class="variable">$buffer</span>) . <span class="string">") to client, you need to convert it to a string. "</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="variable">$len</span> = \<span class="title function_ invoke__">strlen</span>(<span class="variable">$buffer</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$first_byte</span> = <span class="string">"\x81"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$len</span> &lt;= <span class="number">125</span>) {</span><br><span class="line">        <span class="variable">$encode_buffer</span> = <span class="variable">$first_byte</span> . \<span class="title function_ invoke__">chr</span>(<span class="variable">$len</span>) . <span class="variable">$buffer</span>;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$len</span> &lt;= <span class="number">65535</span>) {</span><br><span class="line">            <span class="variable">$encode_buffer</span> = <span class="variable">$first_byte</span> . \<span class="title function_ invoke__">chr</span>(<span class="number">126</span>) . \<span class="title function_ invoke__">pack</span>(<span class="string">"n"</span>, <span class="variable">$len</span>) . <span class="variable">$buffer</span>;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="variable">$encode_buffer</span> = <span class="variable">$first_byte</span> . \<span class="title function_ invoke__">chr</span>(<span class="number">127</span>) . \<span class="title function_ invoke__">pack</span>(<span class="string">"xxxxN"</span>, <span class="variable">$len</span>) . <span class="variable">$buffer</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$encode_buffer</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>æˆ‘ä»¬ä¿®æ”¹åˆšæ‰ <a href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%B8%8E%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%8F%A1%E6%89%8B">å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯æ¡æ‰‹</a> é˜¶æ®µçš„ä»£ç ï¼Œä¿®æ”¹åå…¨ä»£ç å…¨æ–‡å¦‚ä¸‹ï¼Œè¯¥æ®µä»£ç å®ç°äº†å°†å®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯è½¬ä¸ºå¤§å†™åè¿”å›ç»™å®¢æˆ·ç«¯ï¼ˆå½“ç„¶åªæ˜¯ä¸ºäº†æ¼”ç¤ºï¼‰ï¼š</p><figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$socket</span> = <span class="title function_ invoke__">socket_create</span>(AF_INET, SOCK_STREAM, SOL_TCP);</span><br><span class="line"><span class="title function_ invoke__">socket_set_option</span>(<span class="variable">$socket</span>, SOL_SOCKET, SO_REUSEADDR, <span class="literal">true</span>);</span><br><span class="line"><span class="title function_ invoke__">socket_bind</span>(<span class="variable">$socket</span>, <span class="number">0</span>, <span class="number">8888</span>);</span><br><span class="line"><span class="title function_ invoke__">socket_listen</span>(<span class="variable">$socket</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">    <span class="variable">$conn_sock</span> = <span class="title function_ invoke__">socket_accept</span>(<span class="variable">$socket</span>);</span><br><span class="line">    <span class="variable">$request</span> = <span class="title function_ invoke__">socket_read</span>(<span class="variable">$conn_sock</span>, <span class="number">102400</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$new_key</span> = <span class="title function_ invoke__">getShaKey</span>(<span class="variable">$request</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$response</span> = <span class="string">"HTTP/1.1 101 Switching Protocols\r\n"</span>;</span><br><span class="line">    <span class="variable">$response</span> .= <span class="string">"Upgrade: websocket\r\n"</span>;</span><br><span class="line">    <span class="variable">$response</span> .= <span class="string">"Sec-WebSocket-Version: 13\r\n"</span>;</span><br><span class="line">    <span class="variable">$response</span> .= <span class="string">"Connection: Upgrade\r\n"</span>;</span><br><span class="line">    <span class="variable">$response</span> .= <span class="string">"Sec-WebSocket-Accept: <span class="subst">{$new_key}</span>\r\n\r\n"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‘é€æ¡æ‰‹æ•°æ®</span></span><br><span class="line">    <span class="title function_ invoke__">socket_write</span>(<span class="variable">$conn_sock</span>, <span class="variable">$response</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–°å¢å†…å®¹ï¼Œè·å–å®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯å¹¶è½¬ä¸ºå¤§å†™è¿˜ç»™å®¢æˆ·ç«¯</span></span><br><span class="line">    <span class="variable">$msg</span> = <span class="title function_ invoke__">socket_read</span>(<span class="variable">$conn_sock</span>, <span class="number">102400</span>);</span><br><span class="line">    <span class="title function_ invoke__">socket_write</span>(<span class="variable">$conn_sock</span>, <span class="title function_ invoke__">encode</span>(<span class="title function_ invoke__">strtoupper</span>(<span class="title function_ invoke__">decode</span>(<span class="variable">$msg</span>))));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getShaKey</span>(<span class="params"><span class="variable">$request</span></span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="comment">// è·å– Sec-WebSocket-key</span></span><br><span class="line">    <span class="title function_ invoke__">preg_match</span>(<span class="string">"/Sec-WebSocket-Key: (.*)\r\n/"</span>, <span class="variable">$request</span>, <span class="variable">$match</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‹¼æ¥ key + 258EAFA5-E914-47DA-95CA-C5AB0DC85B11</span></span><br><span class="line">    <span class="variable">$new_key</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$match</span>[<span class="number">1</span>]) . <span class="string">'258EAFA5-E914-47DA-95CA-C5AB0DC85B11'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯¹å­—ç¬¦ä¸²åš `SHA1` è®¡ç®—ï¼Œå†æŠŠå¾—åˆ°çš„ç»“æœé€šè¿‡ `base64` åŠ å¯†</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">sha1</span>(<span class="variable">$new_key</span>, <span class="literal">true</span>));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">decode</span>(<span class="params"><span class="variable">$buffer</span></span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="variable">$len</span> = \<span class="title function_ invoke__">ord</span>(<span class="variable">$buffer</span>[<span class="number">1</span>]) &amp; <span class="number">127</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$len</span> === <span class="number">126</span>) {</span><br><span class="line">        <span class="variable">$masks</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">4</span>, <span class="number">4</span>);</span><br><span class="line">        <span class="variable">$data</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">8</span>);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$len</span> === <span class="number">127</span>) {</span><br><span class="line">            <span class="variable">$masks</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">10</span>, <span class="number">4</span>);</span><br><span class="line">            <span class="variable">$data</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">14</span>);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="variable">$masks</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">2</span>, <span class="number">4</span>);</span><br><span class="line">            <span class="variable">$data</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">6</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="variable">$dataLength</span> = \<span class="title function_ invoke__">strlen</span>(<span class="variable">$data</span>);</span><br><span class="line">    <span class="variable">$masks</span> = \<span class="title function_ invoke__">str_repeat</span>(<span class="variable">$masks</span>, \<span class="title function_ invoke__">floor</span>(<span class="variable">$dataLength</span> / <span class="number">4</span>)) . \<span class="title function_ invoke__">substr</span>(<span class="variable">$masks</span>, <span class="number">0</span>, <span class="variable">$dataLength</span> % <span class="number">4</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$data</span> ^ <span class="variable">$masks</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">encode</span>(<span class="params"><span class="variable">$buffer</span></span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">is_scalar</span>(<span class="variable">$buffer</span>)) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">\Exception</span>(<span class="string">"You can't send("</span> . \<span class="title function_ invoke__">gettype</span>(<span class="variable">$buffer</span>) . <span class="string">") to client, you need to convert it to a string. "</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="variable">$len</span> = \<span class="title function_ invoke__">strlen</span>(<span class="variable">$buffer</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$first_byte</span> = <span class="string">"\x81"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$len</span> &lt;= <span class="number">125</span>) {</span><br><span class="line">        <span class="variable">$encode_buffer</span> = <span class="variable">$first_byte</span> . \<span class="title function_ invoke__">chr</span>(<span class="variable">$len</span>) . <span class="variable">$buffer</span>;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$len</span> &lt;= <span class="number">65535</span>) {</span><br><span class="line">            <span class="variable">$encode_buffer</span> = <span class="variable">$first_byte</span> . \<span class="title function_ invoke__">chr</span>(<span class="number">126</span>) . \<span class="title function_ invoke__">pack</span>(<span class="string">"n"</span>, <span class="variable">$len</span>) . <span class="variable">$buffer</span>;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="variable">$encode_buffer</span> = <span class="variable">$first_byte</span> . \<span class="title function_ invoke__">chr</span>(<span class="number">127</span>) . \<span class="title function_ invoke__">pack</span>(<span class="string">"xxxxN"</span>, <span class="variable">$len</span>) . <span class="variable">$buffer</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$encode_buffer</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>ä½¿ç”¨ <a target="_blank" rel="noopener" href="http://www.websocket-test.com/">åœ¨çº¿æµ‹è¯•å·¥å…·</a> è¿›è¡Œæµ‹è¯•ï¼Œå¯ä»¥çœ‹åˆ°æ¶ˆæ¯å·²ç»å¯ä»¥æ­£å¸¸å‘é€æ¥æ”¶ï¼Œæ¥ä¸‹æ¥çš„æ–‡ç« å°†ç»§ç»­ä¼˜åŒ–ä»£ç ï¼Œå®ç°ç®€æ˜“èŠå¤©å®¤ï¼Œæ•¬è¯·å…³æ³¨ï¼š</p><p><a class="simple-lightbox" target="_blank" rel="noopener" href="https://cdn.codeover.cn/img/GIF2022-6-2023-53-02.gif-imageFop"><img src="/images/loading.svg" data-src="https://cdn.codeover.cn/img/GIF2022-6-2023-53-02.gif-imageFop" alt="æµ‹è¯•æˆªå›¾" lazyload=""></a></p><h2 id="å®ç°webèŠå¤©å®¤"><a href="#å®ç°webèŠå¤©å®¤" class="headerlink" title="å®ç°webèŠå¤©å®¤"></a>å®ç°webèŠå¤©å®¤</h2><p>æˆ‘ä»¬ç´§æ¥ç€ä¸Šæ–‡çš„ä»£ç ç»§ç»­ä¼˜åŒ–ï¼Œä»¥å®ç°ç®€æ˜“çš„webèŠå¤©å®¤</p><h3 id="å¤šè·¯å¤ç”¨"><a href="#å¤šè·¯å¤ç”¨" class="headerlink" title="å¤šè·¯å¤ç”¨"></a>å¤šè·¯å¤ç”¨</h3><p>å…¶å®å°±æ˜¯åŠ ä¸€ä¸‹ <code>socket_select()</code> å‡½æ•° <span class="github-emoji"><span>ğŸ˜‚</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f602.png?v8" aria-hidden="true" onerror='this.parent.classList.add("github-emoji-fallback")'></span> ï¼Œæœ¬æ–‡å°±ä¸å†™åŸç†ä¸è¯­æ³•äº†ï¼Œè¯¦æƒ…å¯å‚è€ƒ <a href="https://www.codeover.cn/php-socket-http/#%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8">ä¹‹å‰çš„æ–‡ç« </a>ï¼Œä»¥ä¸‹ä»£ç ä¿®æ”¹è‡ªå‰æ–‡ <a href="#%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E4%B8%8E%E6%8E%A5%E6%94%B6%E6%95%B0%E6%8D%AE">å‘é€æ•°æ®ä¸æ¥æ”¶æ•°æ®</a></p><figure class="highlight diff"><table><tbody><tr><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line">socket_listen($socket);</span><br><span class="line"></span><br><span class="line"><span class="addition">+$sockets[] = $socket;</span></span><br><span class="line"><span class="addition">+$user = [];</span></span><br><span class="line">while (true) {</span><br><span class="line"><span class="addition">+   $tmp_sockets = $sockets;</span></span><br><span class="line"><span class="addition">+   socket_select($tmp_sockets, $write, $except, null);</span></span><br><span class="line"></span><br><span class="line"><span class="addition">+   foreach ($tmp_sockets as $sock) {</span></span><br><span class="line"><span class="addition">+       if ($sock == $socket) {</span></span><br><span class="line"><span class="addition">+           $sockets[] = socket_accept($socket);</span></span><br><span class="line"><span class="addition">+           $user[] = ['socket' =&gt; $socket, 'handshake' =&gt; false];</span></span><br><span class="line"><span class="addition">+       } else {</span></span><br><span class="line"><span class="addition">+           $curr_user = $user[array_search($sock, $user)];</span></span><br><span class="line"><span class="addition">+           if ($curr_user['handshake']) { // å·²æ¡æ‰‹</span></span><br><span class="line"><span class="addition">+               $msg = socket_read($sock, 102400);</span></span><br><span class="line"><span class="addition">+               echo 'å®¢æˆ·ç«¯å‘æ¥æ¶ˆæ¯' . decode($msg);</span></span><br><span class="line"><span class="addition">+               socket_write($sock, encode('è¿™æ˜¯æ¥è‡ªæœåŠ¡ç«¯çš„æ¶ˆæ¯'));</span></span><br><span class="line"><span class="addition">+           } else {</span></span><br><span class="line"><span class="addition">+               // æ¡æ‰‹</span></span><br><span class="line"><span class="addition">+           }</span></span><br><span class="line"><span class="addition">+       }</span></span><br><span class="line"><span class="addition">+   }</span></span><br><span class="line"></span><br><span class="line"><span class="deletion">-   $conn_sock = socket_accept($socket);</span></span><br><span class="line"><span class="deletion">-   $request = socket_read($conn_sock, 102400);</span></span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure><h3 id="å®ç°èŠå¤©å®¤"><a href="#å®ç°èŠå¤©å®¤" class="headerlink" title="å®ç°èŠå¤©å®¤"></a>å®ç°èŠå¤©å®¤</h3><p>æœ€ç»ˆæˆæœæ¼”ç¤º</p><p><a class="simple-lightbox" target="_blank" rel="noopener" href="https://cdn.codeover.cn/img/GIF2022-6-2323-15-24.gif-imageFop"><img src="/images/loading.svg" data-src="https://cdn.codeover.cn/img/GIF2022-6-2323-15-24.gif-imageFop" alt="websocketæˆæœæ¼”ç¤º" lazyload=""></a></p><p>æˆ‘ä»¬å°†ä¸Šè¿°ä»£ç æ”¹é€ æˆç±»ï¼Œå¹¶åœ¨ç±»å˜é‡å‚¨å­˜ç”¨æˆ·ä¿¡æ¯ï¼Œæ·»åŠ æ¶ˆæ¯å¤„ç†ç­‰é€»è¾‘ï¼Œæœ€åè´´å‡ºä»£ç ï¼Œå»ºè®®ä¿å­˜ä¸‹æ¥è‡ªå·±å°è¯•ä¸€ä¸‹ï¼Œä¹Ÿè®¸ä¼šæœ‰å…¨æ–°çš„è®¤çŸ¥ï¼Œåç«¯ä»£ç ï¼š</p><figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">WebSocket</span>();</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Websocket</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> resource</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$socket</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array ç”¨æˆ·åˆ—è¡¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$user</span> = [];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array å­˜æ”¾æ‰€æœ‰ socket èµ„æº</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$socket_list</span> = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;socket = <span class="title function_ invoke__">socket_create</span>(AF_INET, SOCK_STREAM, SOL_TCP);</span><br><span class="line">        <span class="title function_ invoke__">socket_set_option</span>(<span class="variable">$this</span>-&gt;socket, SOL_SOCKET, SO_REUSEADDR, <span class="literal">true</span>);</span><br><span class="line">        <span class="title function_ invoke__">socket_bind</span>(<span class="variable">$this</span>-&gt;socket, <span class="number">0</span>, <span class="number">8888</span>);</span><br><span class="line">        <span class="title function_ invoke__">socket_listen</span>(<span class="variable">$this</span>-&gt;socket);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å°† socket èµ„æºæ”¾å…¥ socket_list</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;socket_list[] = <span class="variable language_">$this</span>-&gt;socket;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">            <span class="variable">$tmp_sockets</span> = <span class="variable language_">$this</span>-&gt;socket_list;</span><br><span class="line">            <span class="title function_ invoke__">socket_select</span>(<span class="variable">$tmp_sockets</span>, <span class="variable">$write</span>, <span class="variable">$except</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$tmp_sockets</span> <span class="keyword">as</span> <span class="variable">$sock</span>) {</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable">$sock</span> == <span class="variable language_">$this</span>-&gt;socket) {</span><br><span class="line">                    <span class="variable">$conn_sock</span> = <span class="title function_ invoke__">socket_accept</span>(<span class="variable">$sock</span>);</span><br><span class="line">                    <span class="variable language_">$this</span>-&gt;socket_list[] = <span class="variable">$conn_sock</span>;</span><br><span class="line">                    <span class="variable language_">$this</span>-&gt;user[] = [<span class="string">'socket'</span> =&gt; <span class="variable">$conn_sock</span>, <span class="string">'handshake'</span> =&gt; <span class="literal">false</span>, <span class="string">'name'</span> =&gt; <span class="string">'æ— åæ°'</span>];</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    <span class="variable">$request</span> = <span class="title function_ invoke__">socket_read</span>(<span class="variable">$sock</span>, <span class="number">102400</span>);</span><br><span class="line">                    <span class="variable">$k</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getUserIndex</span>(<span class="variable">$sock</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (!<span class="variable">$request</span>) {</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    }</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// ç”¨æˆ·ç«¯æ–­å¼€è¿æ¥</span></span><br><span class="line">                    <span class="keyword">if</span> ((\<span class="title function_ invoke__">ord</span>(<span class="variable">$request</span>[<span class="number">0</span>]) &amp; <span class="number">0xf</span>) == <span class="number">0x8</span>) {</span><br><span class="line">                        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">close</span>(<span class="variable">$k</span>);</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    }</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (!<span class="variable language_">$this</span>-&gt;user[<span class="variable">$k</span>][<span class="string">'handshake'</span>]) {</span><br><span class="line">                        <span class="comment">// æ¡æ‰‹</span></span><br><span class="line">                        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">handshake</span>(<span class="variable">$k</span>, <span class="variable">$request</span>);</span><br><span class="line">                    } <span class="keyword">else</span> {</span><br><span class="line">                        <span class="comment">// å·²æ¡æ‰‹</span></span><br><span class="line">                        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">send</span>(<span class="variable">$k</span>, <span class="variable">$request</span>);</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å…³é—­è¿æ¥</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $k</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span>(<span class="params"><span class="variable">$k</span></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="variable">$u_name</span> = <span class="variable language_">$this</span>-&gt;user[<span class="variable">$k</span>][<span class="string">'name'</span>] ?? <span class="string">'æ— åæ°'</span>;</span><br><span class="line">        <span class="title function_ invoke__">socket_close</span>(<span class="variable">$this</span>-&gt;user[<span class="variable">$k</span>][<span class="string">'socket'</span>]);</span><br><span class="line">        <span class="variable">$socket_key</span> = <span class="title function_ invoke__">array_search</span>(<span class="variable">$this</span>-&gt;user[<span class="variable">$k</span>][<span class="string">'socket'</span>], <span class="variable">$this</span>-&gt;socket_list);</span><br><span class="line">        <span class="keyword">unset</span>(<span class="variable language_">$this</span>-&gt;socket_list[<span class="variable">$socket_key</span>]);</span><br><span class="line">        <span class="keyword">unset</span>(<span class="variable language_">$this</span>-&gt;user[<span class="variable">$k</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$user</span> = [];</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;user <span class="keyword">as</span> <span class="variable">$v</span>) {</span><br><span class="line">            <span class="variable">$user</span>[] = <span class="variable">$v</span>[<span class="string">'name'</span>];</span><br><span class="line">        }</span><br><span class="line">        <span class="variable">$res</span> = [</span><br><span class="line">            <span class="string">'type'</span> =&gt; <span class="string">'close'</span>,</span><br><span class="line">            <span class="string">'users'</span> =&gt; <span class="variable">$user</span>,</span><br><span class="line">            <span class="string">'msg'</span> =&gt; <span class="variable">$u_name</span> . <span class="string">'å·²é€€å‡º'</span>,</span><br><span class="line">            <span class="string">'time'</span> =&gt; <span class="title function_ invoke__">date</span>(<span class="string">'Y-m-d H:i:s'</span>)</span><br><span class="line">        ];</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">sendAllUser</span>(<span class="variable">$res</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–ç”¨æˆ·ç´¢å¼•</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $socket</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> int|string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getUserIndex</span>(<span class="params"><span class="variable">$socket</span></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;user <span class="keyword">as</span> <span class="variable">$k</span> =&gt; <span class="variable">$v</span>) {</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$v</span>[<span class="string">'socket'</span>] == <span class="variable">$socket</span>) {</span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$k</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¡æ‰‹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $k</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $request</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">handshake</span>(<span class="params"><span class="variable">$k</span>, <span class="variable">$request</span></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="title function_ invoke__">preg_match</span>(<span class="string">"/Sec-WebSocket-Key: (.*)\r\n/"</span>, <span class="variable">$request</span>, <span class="variable">$match</span>);</span><br><span class="line">        <span class="variable">$key</span> = <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">sha1</span>(<span class="variable">$match</span>[<span class="number">1</span>] . <span class="string">'258EAFA5-E914-47DA-95CA-C5AB0DC85B11'</span>, <span class="literal">true</span>));</span><br><span class="line"></span><br><span class="line">        <span class="variable">$response</span> = <span class="string">"HTTP/1.1 101 Switching Protocols\r\n"</span>;</span><br><span class="line">        <span class="variable">$response</span> .= <span class="string">"Upgrade: websocket\r\n"</span>;</span><br><span class="line">        <span class="variable">$response</span> .= <span class="string">"Connection: Upgrade\r\n"</span>;</span><br><span class="line">        <span class="variable">$response</span> .= <span class="string">"Sec-WebSocket-Accept: <span class="subst">{$key}</span>\r\n\r\n"</span>;</span><br><span class="line">        <span class="title function_ invoke__">socket_write</span>(<span class="variable">$this</span>-&gt;user[<span class="variable">$k</span>][<span class="string">'socket'</span>], <span class="variable">$response</span>);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;user[<span class="variable">$k</span>][<span class="string">'handshake'</span>] = <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¥æ”¶å¹¶å¤„ç†æ¶ˆæ¯</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $k</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $msg</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">send</span>(<span class="params"><span class="variable">$k</span>, <span class="variable">$msg</span></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="variable">$msg</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">decode</span>(<span class="variable">$msg</span>);</span><br><span class="line">        <span class="variable">$msg</span> = <span class="title function_ invoke__">json_decode</span>(<span class="variable">$msg</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$msg</span>[<span class="string">'type'</span>])) {</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (<span class="variable">$msg</span>[<span class="string">'type'</span>]) {</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'login'</span>: <span class="comment">// ç™»å½•</span></span><br><span class="line">                <span class="variable language_">$this</span>-&gt;user[<span class="variable">$k</span>][<span class="string">'name'</span>] = <span class="variable">$msg</span>[<span class="string">'name'</span>] ?? <span class="string">'æ— åæ°'</span>;</span><br><span class="line">                <span class="variable">$users</span> = [];</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;user <span class="keyword">as</span> <span class="variable">$v</span>) {</span><br><span class="line">                    <span class="variable">$users</span>[] = <span class="variable">$v</span>[<span class="string">'name'</span>];</span><br><span class="line">                }</span><br><span class="line">                <span class="variable">$res</span> = [</span><br><span class="line">                    <span class="string">'type'</span> =&gt; <span class="string">'login'</span>,</span><br><span class="line">                    <span class="string">'name'</span> =&gt; <span class="variable language_">$this</span>-&gt;user[<span class="variable">$k</span>][<span class="string">'name'</span>],</span><br><span class="line">                    <span class="string">'msg'</span> =&gt; <span class="variable language_">$this</span>-&gt;user[<span class="variable">$k</span>][<span class="string">'name'</span>] . <span class="string">': login success'</span>,</span><br><span class="line">                    <span class="string">'users'</span> =&gt; <span class="variable">$users</span>,</span><br><span class="line">                ];</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">sendAllUser</span>(<span class="variable">$res</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'message'</span>: <span class="comment">// æ¥æ”¶å¹¶å‘é€æ¶ˆæ¯</span></span><br><span class="line">                <span class="variable">$res</span> = [</span><br><span class="line">                    <span class="string">'type'</span> =&gt; <span class="string">'message'</span>,</span><br><span class="line">                    <span class="string">'name'</span> =&gt; <span class="variable language_">$this</span>-&gt;user[<span class="variable">$k</span>][<span class="string">'name'</span>] ?? <span class="string">'æ— åæ°'</span>,</span><br><span class="line">                    <span class="string">'msg'</span> =&gt; <span class="variable">$msg</span>[<span class="string">'msg'</span>],</span><br><span class="line">                    <span class="string">'time'</span> =&gt; <span class="title function_ invoke__">date</span>(<span class="string">'H:i:s'</span>),</span><br><span class="line">                ];</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">sendAllUser</span>(<span class="variable">$res</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å‘é€ç»™æ‰€æœ‰äºº</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">sendAllUser</span>(<span class="params"><span class="variable">$msg</span></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$msg</span>)) {</span><br><span class="line">            <span class="variable">$msg</span> = <span class="title function_ invoke__">json_encode</span>(<span class="variable">$msg</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="variable">$msg</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">encode</span>(<span class="variable">$msg</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;user <span class="keyword">as</span> <span class="variable">$k</span> =&gt; <span class="variable">$v</span>) {</span><br><span class="line">            <span class="title function_ invoke__">socket_write</span>(<span class="variable">$v</span>[<span class="string">'socket'</span>], <span class="variable">$msg</span>, <span class="title function_ invoke__">strlen</span>(<span class="variable">$msg</span>));</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è§£ç </span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $buffer</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">decode</span>(<span class="params"><span class="variable">$buffer</span></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="variable">$len</span> = \<span class="title function_ invoke__">ord</span>(<span class="variable">$buffer</span>[<span class="number">1</span>]) &amp; <span class="number">127</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$len</span> === <span class="number">126</span>) {</span><br><span class="line">            <span class="variable">$masks</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">4</span>, <span class="number">4</span>);</span><br><span class="line">            <span class="variable">$data</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">8</span>);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$len</span> === <span class="number">127</span>) {</span><br><span class="line">                <span class="variable">$masks</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">10</span>, <span class="number">4</span>);</span><br><span class="line">                <span class="variable">$data</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">14</span>);</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="variable">$masks</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">2</span>, <span class="number">4</span>);</span><br><span class="line">                <span class="variable">$data</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">6</span>);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="variable">$dataLength</span> = \<span class="title function_ invoke__">strlen</span>(<span class="variable">$data</span>);</span><br><span class="line">        <span class="variable">$masks</span> = \<span class="title function_ invoke__">str_repeat</span>(<span class="variable">$masks</span>, \<span class="title function_ invoke__">floor</span>(<span class="variable">$dataLength</span> / <span class="number">4</span>)) . \<span class="title function_ invoke__">substr</span>(<span class="variable">$masks</span>, <span class="number">0</span>, <span class="variable">$dataLength</span> % <span class="number">4</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$data</span> ^ <span class="variable">$masks</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">encode</span>(<span class="params"><span class="variable">$buffer</span></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">is_scalar</span>(<span class="variable">$buffer</span>)) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">\Exception</span>(<span class="string">"You can't send("</span> . \<span class="title function_ invoke__">gettype</span>(<span class="variable">$buffer</span>) . <span class="string">") to client, you need to convert it to a string. "</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="variable">$len</span> = \<span class="title function_ invoke__">strlen</span>(<span class="variable">$buffer</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$first_byte</span> = <span class="string">"\x81"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$len</span> &lt;= <span class="number">125</span>) {</span><br><span class="line">            <span class="variable">$encode_buffer</span> = <span class="variable">$first_byte</span> . \<span class="title function_ invoke__">chr</span>(<span class="variable">$len</span>) . <span class="variable">$buffer</span>;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$len</span> &lt;= <span class="number">65535</span>) {</span><br><span class="line">                <span class="variable">$encode_buffer</span> = <span class="variable">$first_byte</span> . \<span class="title function_ invoke__">chr</span>(<span class="number">126</span>) . \<span class="title function_ invoke__">pack</span>(<span class="string">"n"</span>, <span class="variable">$len</span>) . <span class="variable">$buffer</span>;</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="variable">$encode_buffer</span> = <span class="variable">$first_byte</span> . \<span class="title function_ invoke__">chr</span>(<span class="number">127</span>) . \<span class="title function_ invoke__">pack</span>(<span class="string">"xxxxN"</span>, <span class="variable">$len</span>) . <span class="variable">$buffer</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$encode_buffer</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>å‰ç«¯ä»£ç å¦‚ä¸‹ï¼ˆå‰ç«¯å†…å®¹ä¸åœ¨æœ¬æ–‡è®¨è®ºèŒƒå›´ä¹‹å†…ï¼Œå…·ä½“å¯å‚è€ƒ <a target="_blank" rel="noopener" href="https://www.runoob.com/html/html5-websocket.html">èœé¸Ÿæ•™ç¨‹</a>ï¼‰ï¼š</p><figure class="highlight html"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"zh-CN"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">content</span>=<span class="string">"width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"ie=edge"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    * {</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">padding</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">h3</span> {</span></span><br><span class="line"><span class="language-css">        <span class="attribute">display</span>: flex;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">justify-content</span>: center;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin</span>: <span class="number">30px</span> auto;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.but-box</span> {</span></span><br><span class="line"><span class="language-css">        <span class="attribute">border-radius</span>: <span class="number">5px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">display</span>: flex;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">justify-content</span>: center;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">align-items</span>: center;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin-top</span>: <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#box</span> {</span></span><br><span class="line"><span class="language-css">        <span class="attribute">display</span>: flex;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin</span>: <span class="number">5px</span> auto;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">border-radius</span>: <span class="number">5px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">border</span>: <span class="number">1px</span> <span class="number">#ccc</span> solid;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">height</span>: <span class="number">400px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">width</span>: <span class="number">700px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">overflow-y</span>: auto;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">overflow-x</span>: hidden;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">position</span>: relative;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#msg-box</span> {</span></span><br><span class="line"><span class="language-css">        <span class="attribute">width</span>: <span class="number">480px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin-right</span>: <span class="number">111px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">height</span>: <span class="number">100%</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">overflow-y</span>: auto;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">overflow-x</span>: hidden;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#user-box</span> {</span></span><br><span class="line"><span class="language-css">        <span class="attribute">width</span>: <span class="number">110px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">overflow-y</span>: auto;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">overflow-x</span>: hidden;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">float</span>: left;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">border-left</span>: <span class="number">1px</span> <span class="number">#ccc</span> solid;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">height</span>: <span class="number">100%</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">background-color</span>: <span class="number">#F1F1F1</span>;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">button</span> {</span></span><br><span class="line"><span class="language-css">        <span class="attribute">float</span>: right;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">width</span>: <span class="number">80px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">height</span>: <span class="number">35px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">font-size</span>: <span class="number">18px</span>;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">input</span> {</span></span><br><span class="line"><span class="language-css">        <span class="attribute">width</span>: <span class="number">100%</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">height</span>: <span class="number">30px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">padding</span>: <span class="number">2px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">line-height</span>: <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">outline</span>: none;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">border</span>: solid <span class="number">1px</span> <span class="number">#CCC</span>;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.but-box</span> <span class="selector-tag">p</span> {</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin-right</span>: <span class="number">160px</span>;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>è¿™æ˜¯ä¸€ä¸ªphp socketå®ç°çš„webèŠå¤©å®¤<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"box"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"msg-box"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"user-box"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"but-box"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">textarea</span> <span class="attr">cols</span>=<span class="string">"60"</span> <span class="attr">rows</span>=<span class="string">"3"</span> <span class="attr">style</span>=<span class="string">"resize:none;pedding: 10px"</span>    <span class="attr">id</span>=<span class="string">"content"</span>&gt;</span> <span class="tag">&lt;/<span class="name">textarea</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"send"</span>&gt;</span>å‘é€<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.bootcss.com/jquery/2.2.1/jquery.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> ws = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(<span class="string">'ws://124.222.85.67:8888'</span>);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    ws.<span class="property">onopen</span> = <span class="keyword">function</span> (<span class="params">event</span>) {</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'è¿æ¥æˆåŠŸ'</span>);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> name = <span class="title function_">prompt</span>(<span class="string">'è¯·è¾“å…¥ç”¨æˆ·å:'</span>);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        ws.<span class="title function_">send</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>({</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">type</span>: <span class="string">'login'</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">name</span>: name</span></span><br><span class="line"><span class="language-javascript">        }));</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span> (!name) {</span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">alert</span>(<span class="string">'å¥½ä½ ä¸ªåè›‹ï¼Œç«Ÿç„¶æ²¡æœ‰è¾“å…¥ç”¨æˆ·å'</span>);</span></span><br><span class="line"><span class="language-javascript">        }</span></span><br><span class="line"><span class="language-javascript">    };</span></span><br><span class="line"><span class="language-javascript">    ws.<span class="property">onmessage</span> = <span class="keyword">function</span> (<span class="params">event</span>) {</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> data = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(event.<span class="property">data</span>);</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">switch</span> (data.<span class="property">type</span>) {</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">case</span> <span class="string">'close'</span>:</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">case</span> <span class="string">'login'</span>:</span></span><br><span class="line"><span class="language-javascript">                $(<span class="string">"#user-box"</span>).<span class="title function_">html</span>(<span class="string">''</span>);</span></span><br><span class="line"><span class="language-javascript">                data.<span class="property">users</span>.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">item</span>) {</span></span><br><span class="line"><span class="language-javascript">                    $(<span class="string">"#user-box"</span>).<span class="title function_">append</span>(<span class="string">`&lt;p style="color: grey;"&gt;<span class="subst">${item}</span>&lt;/p&gt;`</span>);</span></span><br><span class="line"><span class="language-javascript">                });</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">if</span> (data.<span class="property">msg</span>) {</span></span><br><span class="line"><span class="language-javascript">                    $(<span class="string">"#msg-box"</span>).<span class="title function_">append</span>(<span class="string">`&lt;p style="color: grey;"&gt;<span class="subst">${data.msg}</span>&lt;/p&gt;`</span>);</span></span><br><span class="line"><span class="language-javascript">                }</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">break</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">case</span> <span class="string">'message'</span>:</span></span><br><span class="line"><span class="language-javascript">                $(<span class="string">"#msg-box"</span>).<span class="title function_">append</span>(<span class="string">`&lt;p&gt;&lt;span style="color: #0A89FF"&gt;<span class="subst">${data.time}</span>&lt;/span&gt;&lt;span style="color: red"&gt;<span class="subst">${data.name}</span>&lt;/span&gt;<span class="subst">${data.msg}</span>&lt;/p&gt;`</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">break</span>;</span></span><br><span class="line"><span class="language-javascript">        }</span></span><br><span class="line"><span class="language-javascript">    };</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    ws.<span class="property">onclose</span> = <span class="keyword">function</span> (<span class="params">event</span>) {</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">alert</span>(<span class="string">'è¿æ¥å…³é—­'</span>);</span></span><br><span class="line"><span class="language-javascript">    };</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">document</span>.<span class="property">onkeydown</span> = <span class="keyword">function</span> (<span class="params">event</span>) {</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span> (event.<span class="property">keyCode</span> == <span class="number">13</span>) {</span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">send</span>();</span></span><br><span class="line"><span class="language-javascript">        }</span></span><br><span class="line"><span class="language-javascript">    }</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    $(<span class="string">"#send"</span>).<span class="title function_">click</span>(<span class="keyword">function</span> (<span class="params"></span>) {</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">send</span>();</span></span><br><span class="line"><span class="language-javascript">    });</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">send</span>(<span class="params"></span>) {</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> content = $(<span class="string">"#content"</span>).<span class="title function_">val</span>();</span></span><br><span class="line"><span class="language-javascript">        $(<span class="string">"#content"</span>).<span class="title function_">val</span>(<span class="string">''</span>);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span> (!content) {</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span>;</span></span><br><span class="line"><span class="language-javascript">        }</span></span><br><span class="line"><span class="language-javascript">        ws.<span class="title function_">send</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>({</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">type</span>: <span class="string">'message'</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">msg</span>: content</span></span><br><span class="line"><span class="language-javascript">        }));</span></span><br><span class="line"><span class="language-javascript">    }</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><div id="footnotes"><hr><div id="footnotelist"><ol style="list-style:none;padding-left:0;margin-left:40px"><li id="fn:1"><span style="display:inline-block;vertical-align:top;padding-right:10px;margin-left:-40px">1.</span><span style="display:inline-block;vertical-align:top;margin-left:10px">æ˜¯é€šè®¯ä¼ è¾“çš„ä¸€ä¸ªæœ¯è¯­ã€‚ é€šä¿¡å…è®¸æ•°æ®åœ¨ä¸¤ä¸ªæ–¹å‘ä¸ŠåŒæ—¶ä¼ è¾“ï¼Œå®ƒåœ¨èƒ½åŠ›ä¸Šç›¸å½“äºä¸¤ä¸ªå•å·¥é€šä¿¡æ–¹å¼çš„ç»“åˆ <a href="#fnref:1">â†©</a></span></li><li id="fn:2"><span style="display:inline-block;vertical-align:top;padding-right:10px;margin-left:-40px">2.</span><span style="display:inline-block;vertical-align:top;margin-left:10px">ä¸ºäº†å»ºç«‹ websocket è¿æ¥ï¼Œéœ€è¦é€šè¿‡æµè§ˆå™¨å‘å‡ºè¯·æ±‚ï¼Œä¹‹åæœåŠ¡å™¨è¿›è¡Œå›åº”ï¼Œè¿™ä¸ªè¿‡ç¨‹é€šå¸¸ç§°ä¸ºâ€œæ¡æ‰‹â€ï¼ˆHandshakingï¼‰ <a href="#fnref:2">â†©</a></span></li></ol></div></div></div><div class="top-div"><ol class="top-box"><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#%E5%89%8D%E8%A8%80"><span class="top-box-text">å‰è¨€</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#websocket%E4%BB%8B%E7%BB%8D"><span class="top-box-text">websocketä»‹ç»</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81websocket"><span class="top-box-text">ä¸ºä»€ä¹ˆéœ€è¦websocket</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E7%89%B9%E7%82%B9"><span class="top-box-text">ç‰¹ç‚¹</span></a></li></ol></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#PHP%E5%AE%9E%E7%8E%B0websocket"><span class="top-box-text">PHPå®ç°websocket</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%B8%8E%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%8F%A1%E6%89%8B"><span class="top-box-text">å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯æ¡æ‰‹</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E4%B8%8E%E6%8E%A5%E6%94%B6%E6%95%B0%E6%8D%AE"><span class="top-box-text">å‘é€æ•°æ®ä¸æ¥æ”¶æ•°æ®</span></a></li></ol></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#%E5%AE%9E%E7%8E%B0web%E8%81%8A%E5%A4%A9%E5%AE%A4"><span class="top-box-text">å®ç°webèŠå¤©å®¤</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8"><span class="top-box-text">å¤šè·¯å¤ç”¨</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E5%AE%9E%E7%8E%B0%E8%81%8A%E5%A4%A9%E5%AE%A4"><span class="top-box-text">å®ç°èŠå¤©å®¤</span></a></li></ol></li></ol></div></div></div><div class="next-post"><a class="purple-link" href="/php-socket-http/"><h3 class="post-title"> ä¸‹ä¸€ç¯‡ï¼šphpåŸç”Ÿsocketä¹‹IOå¤šè·¯å¤ç”¨ä»¥åŠå®ç°webæœåŠ¡å™¨</h3></a></div></div><div id="gitalk-container"></div><footer><div class="site-footer"><div class="social-container"><a aria-label="è·³è½¬è‡³github" href="https://github.com/f-dong" target="_blank"><i class="icon icon-github"></i></a></div> Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <a href="https://github.com/f-dong/hexo-theme-minimalism" target="_blank">Theme</a> | <a href="https://beian.miit.gov.cn" target="_blank">è±«ICPå¤‡2022011962å·</a> | <a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=41010402002848" target="_blank">è±«å…¬ç½‘å®‰å¤‡41010402002848å·</a></div></footer></div><script id="hexo-configurations">window.theme_config={image:{lazyload_enable:!0,photo_zoom:"simple-lightbox"}},window.is_post=!0</script><script src="/js/main.js"></script><script src="/js/gitalk.min.js"></script><script>var gitalk=new Gitalk({clientID:"eaa8ec37487184406145",clientSecret:"77f9955d0267c1331df7cc706cfa385d2befb9c6",repo:"blog",owner:"f-dong",admin:["f-dong"],id:location.pathname.slice(1,location.pathname.lastIndexOf("/")).substring(0,49),distractionFreeMode:!1,createIssueManually:!0});gitalk.render("gitalk-container")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-2GM6102E19"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-2GM6102E19")</script><script src="/js/simple-lightbox.min.js"></script><script>document.addEventListener("DOMContentLoaded",function(){new SimpleLightbox(".post-detail .simple-lightbox",{fileExt:!1,captionsData:"alt"})})</script></body></html>